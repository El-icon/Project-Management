@model Project_Management.Models.Lead_Contact

@{
    ViewBag.Title = "Index";
    Layout = "~/Views/Shared/_Layout.cshtml";
    Project_Management.Models.project_managementEntities db = new Project_Management.Models.project_managementEntities();
    Project_Management.Controllers.PackagesController tech = new Project_Management.Controllers.PackagesController();
     
}

@using Project_Management.setup;


<main>
    <div class="col-xl-12">
        <div class="card">
            <div class="card-body">

                <h4 class="card-title">
                    @Model.name
                </h4>
                @*<p class="card-title-desc">Example of custom tabs</p>*@

                <!-- Nav tabs -->
                <ul class="nav nav-tabs nav-tabs-custom nav-justified" role="tablist">
                    <li class="nav-item">
                        <a class="nav-link active" data-bs-toggle="tab" href="#home1" role="tab">
                            <span class="d-block d-sm-none"><i class="fas fa-home"></i></span>
                            <span class="d-none d-sm-block">Profile</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-bs-toggle="tab" href="#profile1" role="tab">
                            <span class="d-block d-sm-none"><i class="far fa-user"></i></span>
                            <span class="d-none d-sm-block">Deals</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-bs-toggle="tab" href="#messages1" role="tab">
                            <span class="d-block d-sm-none"><i class="far fa-envelope"></i></span>
                            <span class="d-none d-sm-block">Notes</span>
                        </a>
                    </li>
                </ul>

                <!-- Tab panes -->
                <div class="tab-content p-3 text-muted">
                    <div class="tab-pane active" id="home1" role="tabpanel">

                        <div class="row">
                            <div class="col-md-12">
                                <div class="card">
                                    <div class="card-header">
                                        Profile Info
                                    </div>
                                    <div class="card-body d-flex align-items-center">
                                        <div class="card-body">
                                            <ul class="list-group list-group-flush">
                                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                                    🧑 Name <span>@Model.name</span>
                                                </li>
                                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                                    📧 Email <span>@Model.email</span>
                                                </li>
                                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                                    👑 Lead Owner <span>@Model.leadowner</span>
                                                </li>
                                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                                    🔗 Lead Source <span>@Model.leadsource</span>
                                                </li>
                                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                                    🏢 Company Name <span>@Model.company001.name</span>
                                                </li>
                                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                                    🌐 Website <span>@Model.company001.website</span>
                                                </li>
                                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                                    📱 Mobile <span>@Model.company001.mobile</span>
                                                </li>
                                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                                    ☎️ Office Phone <span>@Model.company001.officemobile</span>
                                                </li>
                                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                                    🌍 Country <span>@Model.company001.country</span>
                                                </li>
                                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                                    🗺️ State <span>@Model.company001.state</span>
                                                </li>
                                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                                    🏙️ City <span>@Model.company001.city</span>
                                                </li>
                                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                                    📮 Postal Code <span>@Model.company001.postalcode</span>
                                                </li>
                                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                                    📍 Address <span>
                                                        @Html.Raw((Model.company001.address ?? "").TrimStart().StartsWith("[")
                                                            ? Project_Management.setup.setEditor.getTextString(Model.company001.address)
                                                            : Model.company001.address)
                                                    </span>
                                                </li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                            </div> 
                        </div> 
                    </div>
                    <div class="tab-pane" id="profile1" role="tabpanel">


                        <div class="table-rep-plugin">
                            <div class="table-responsive mb-0" data-pattern="priority-columns">

                                <table id="datatable-buttons"
                                       class="table table-striped table-bordered">
                                    <thead>
                                        <tr>
                                            <th>
                                                SN
                                            </th>
                                            <th>
                                                DEAL NAME
                                            </th>
                                            <th>
                                                LEAD NAME
                                            </th>
                                            <th>
                                                CONTACT DETAILS
                                            </th>
                                            <th>
                                                VALUE
                                            </th>
                                            <th>
                                               CLOSE DATE
                                            </th>
                                            <th>
                                                AMOUNT
                                            </th>
                                            <th>
                                               NEXT FOLLOW UP
                                            </th>
                                            <th>DEAL AGENT</th>
                                            <th>DEAL WATCHER</th>
                                            <th>STAGE</th>
                                            <th>ACTIONS</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @{
                                            var deals = db.Deals.Include("Lead_Contact").ToList(); // use string name
                                            int sn = 0;
                                        }
                                        @foreach (var deal in deals)
                                        {
                                            sn++;
                                            <tr>
                                                <td>@sn</td>
                                                <td>@deal.name</td>
                                                <td>@(deal.Lead_Contact?.name ?? "-")</td>
                                                <td>@(deal.Lead_Contact?.email ?? "-")</td>
                                                <td>@deal.dealvalue</td>
                                                <td>@Convert.ToDateTime(deal.closedate).ToShortDateString()</td>
                                                <td>@deal.dealvalue</td>
                                                <td>-</td>
                                                <td>@deal.dealagent</td>
                                                <td>@deal.dealwatcher</td>
                                                <td>
                                                    <select class="deal-stage form-control"
                                                            data-deal-id="@deal.id"
                                                            data-old="@deal.dealstages">
                                                        <option value="Generated" @(deal.dealstages == "Generated" ? "selected" : "")>Generated</option>
                                                        <option value="Qualified" @(deal.dealstages == "Qualified" ? "selected" : "")>Qualified</option>
                                                        <option value="Initial Contact" @(deal.dealstages == "Initial Contact" ? "selected" : "")>Initial Contact</option>
                                                        <option value="Schedule Appointment" @(deal.dealstages == "Schedule Appointment" ? "selected" : "")>Schedule Appointment</option>
                                                        <option value="Proposal Sent" @(deal.dealstages == "Proposal Sent" ? "selected" : "")>Proposal Sent</option>
                                                        <option value="Win" @(deal.dealstages == "Win" ? "selected" : "")>Win</option>
                                                        <option value="Lost" @(deal.dealstages == "Lost" ? "selected" : "")>Lost</option>
                                                    </select>
                                                </td>      
                                                <td>...</td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    <div class="tab-pane" id="messages1" role="tabpanel">

                        <div class="container mt-12">
                            <h4>Statistics</h4>
                            <p>
                                Here are the details of the registered company. You’ll find information about the browser and desktop used during company registration.
                                This helps detect bots and shows which browsers companies use most for registration.
                            </p>

                            <div class="table-responsive">
                                <table class="table table-bordered align-middle">
                                    <thead class="table-light">
                                        <tr>
                                            <th style="width: 30%;">Type</th>
                                            <th>Value</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr><td>User Agent</td><td>Symfony</td></tr>
                                        <tr><td>isMobile</td><td class="status-icon status-no">❌</td></tr>
                                        <tr><td>isTablet</td><td class="status-icon status-no">❌</td></tr>
                                        <tr><td>isDesktop</td><td class="status-icon status-yes">✅</td></tr>
                                        <tr><td>isBot</td><td class="status-icon status-no">❌</td></tr>
                                        <tr><td>isChrome</td><td class="status-icon status-no">❌</td></tr>
                                        <tr><td>isFirefox</td><td class="status-icon status-no">❌</td></tr>
                                        <tr><td>isOpera</td><td class="status-icon status-no">❌</td></tr>
                                        <tr><td>isSafari</td><td class="status-icon status-no">❌</td></tr>
                                        <tr><td>isEdge</td><td class="status-icon status-no">❌</td></tr>
                                        <tr><td>isInApp</td><td class="status-icon status-no">❌</td></tr>
                                        <tr><td>isIE</td><td class="status-icon status-no">❌</td></tr>
                                        <tr><td>Browser Name</td><td>-</td></tr>
                                        <tr><td>Browser Family</td><td>Unknown</td></tr>
                                        <tr><td>Browser Version</td><td>-</td></tr>
                                        <tr><td>Browser Version Major</td><td>-</td></tr>
                                        <tr><td>Browser Version Minor</td><td>-</td></tr>
                                        <tr><td>Browser Version Patch</td><td>-</td></tr>
                                        <tr><td>Browser Engine</td><td>Unknown</td></tr>
                                        <tr><td>Platform Name</td><td>-</td></tr>
                                        <tr><td>Platform Family</td><td>Unknown</td></tr>
                                        <tr><td>Platform Version</td><td>-</td></tr>
                                        <tr><td>Platform Version Major</td><td>-</td></tr>
                                        <tr><td>Platform Version Minor</td><td>-</td></tr>
                                        <tr><td>Platform Version Patch</td><td>-</td></tr>
                                        <tr><td>isWindows</td><td class="status-icon status-no">❌</td></tr>
                                        <tr><td>isLinux</td><td class="status-icon status-no">❌</td></tr>
                                        <tr><td>isMac</td><td class="status-icon status-no">❌</td></tr>
                                        <tr><td>isAndroid</td><td class="status-icon status-no">❌</td></tr>
                                        <tr><td>Device Family</td><td>Unknown</td></tr>
                                        <tr><td>Device Model</td><td>-</td></tr>
                                        <tr><td>Registered From IP</td><td>-</td></tr>
                                    </tbody>
                                </table>
                            </div>

                        </div>

                    </div>
                </div>

            </div>
        </div>
    </div>



</main>
<script>
    document.getElementById('dates').valueAsDate = new Date();
</script>


<div id="photo" class="modal fade" role="dialog">
    <div class="modal-dialog">

        <!-- Modal content-->
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title">Upload Company Picture</h4>
            </div>
            <div class="modal-body">
                <p class="text-center">
                    Please Select Picture to upload
                </p>
                <form class="" action="@Url.Action("uploadProfilePicture","Companies")" method="post" enctype="multipart/form-data">
                    <input type="file" class="form-control" name="file" />
                    <input type="hidden" name="id" value="@Model.id" class="form-control" />
                    <div class="modal-footer">
                        <button type="submit" class="btn btn-success">Submit</button>
                        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                    </div>
                </form>
            </div>

        </div>

    </div>
</div>
<script>
$('.deal-stage').on('change', function () {
    const $ddl = $(this);
    const dealId = $ddl.data('deal-id');
    const newStage = $ddl.val();

    $.post('@Url.Action("UpdateStage", "Deals")', { id: dealId, stage: newStage })
     .done(function () {
         toastr.success('Stage saved');
     })
     .fail(function () {
         toastr.error('Save failed');
         $ddl.val($ddl.data('old')); // rollback
     });
});
</script>